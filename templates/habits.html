{% extends "base.html" %}

{% block title %}Habits - Achievify{% endblock %}

{% block content %}
<div class="habits-container">
    <div class="page-header">
        <div class="header-content">
            <div class="header-text">
                <h1><i class="fas fa-seedling"></i> Habit Tracker</h1>
                <p>Build consistent habits and transform your life, one day at a time</p>
                <div class="habit-quote">
                    <i class="fas fa-quote-left"></i>
                    "We are what we repeatedly do. Excellence, then, is not an act, but a habit."
                    <span class="quote-author">- Aristotle</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary btn-large" onclick="showAddHabitModal()">
                    <i class="fas fa-plus"></i> Create New Habit
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats Section -->
    <div class="habit-stats-overview">
        <div class="stat-card active-habits">
            <div class="stat-icon">
                <i class="fas fa-fire"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ habit_stats|length }}</div>
                <div class="stat-label">Active Habits</div>
            </div>
        </div>
        <div class="stat-card completed-today">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ habit_stats|selectattr("completed_today")|list|length }}</div>
                <div class="stat-label">Completed Today</div>
            </div>
        </div>
        <div class="stat-card best-streak">
            <div class="stat-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ habit_stats|map(attribute='streak')|max if habit_stats else 0 }}</div>
                <div class="stat-label">Best Streak</div>
            </div>
        </div>
        <div class="stat-card total-logs">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ habit_stats|map(attribute='total_completions')|sum if habit_stats else 0 }}
                </div>
                <div class="stat-label">Total Completions</div>
            </div>
        </div>
    </div>

    {% if habit_stats %}
    <div class="habits-grid">
        {% for stat in habit_stats %}
        <div class="habit-card {% if stat.target_met %}completed{% endif %} category-{{ stat.habit.category }}">
            <div class="habit-card-inner">
                <div class="habit-header">
                    <div class="habit-icon">
                        {% if stat.habit.category == 'health' %}
                        <i class="fas fa-heartbeat"></i>
                        {% elif stat.habit.category == 'fitness' %}
                        <i class="fas fa-dumbbell"></i>
                        {% elif stat.habit.category == 'learning' %}
                        <i class="fas fa-graduation-cap"></i>
                        {% elif stat.habit.category == 'productivity' %}
                        <i class="fas fa-rocket"></i>
                        {% else %}
                        <i class="fas fa-star"></i>
                        {% endif %}
                    </div>
                    <div class="habit-status">
                        {% if stat.target_met %}
                        <div class="status-badge completed">
                            <i class="fas fa-check"></i>
                            Done!
                        </div>
                        {% else %}
                        <div class="status-badge pending">
                            {{ stat.completed_today }}/{{ stat.habit.target_count }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="habit-info">
                    <h3>{{ stat.habit.name }}</h3>
                    <p class="habit-description">{{ stat.habit.description or 'Building this habit daily' }}</p>
                    <div class="habit-meta">
                        <span class="frequency-badge">
                            <i class="fas fa-calendar-alt"></i>
                            {{ stat.habit.frequency|title }}
                        </span>
                        <span class="category-badge">
                            <i class="fas fa-tag"></i>
                            {{ stat.habit.category|title }}
                        </span>
                    </div>
                </div>

                <div class="habit-progress">
                    <div class="progress-header">
                        <span class="progress-label">Today's Progress</span>
                        <span class="progress-percentage">{{ "%.0f"|format((stat.completed_today /
                            stat.habit.target_count * 100) if stat.habit.target_count > 0 else 0) }}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill"
                            style="width: '{{ (stat.completed_today / stat.habit.target_count * 100) if stat.habit.target_count > 0 else 0 }}%'">
                        </div>
                    </div>
                </div>

                <div class="habit-stats">
                    <div class="stat-item streak">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">{{ stat.streak }}</div>
                            <div class="stat-text">Day Streak</div>
                        </div>
                    </div>
                    <div class="stat-item completions">
                        <div class="stat-icon">
                            <i class="fas fa-check-double"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">{{ stat.total_completions }}</div>
                            <div class="stat-text">Total</div>
                        </div>
                    </div>
                </div>

                <div class="habit-actions">
                    {% if not stat.target_met %}
                    <button class="action-btn log-btn" onclick="logHabit('{{ stat.habit.id }}')">
                        <i class="fas fa-plus-circle"></i>
                        <span>Log Progress</span>
                    </button>
                    {% else %}
                    <div class="completed-badge">
                        <i class="fas fa-trophy"></i>
                        <span>Completed Today!</span>
                    </div>
                    {% endif %}
                    <div class="secondary-actions">
                        <button class="action-btn-small edit-btn" onclick="editHabit('{{ stat.habit.id }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn-small delete-btn" onclick="deleteHabit('{{ stat.habit.id }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-calendar-plus"></i>
        </div>
        <h3>No Habits Yet</h3>
        <p>Start building lasting habits by creating your first habit tracker. Small daily actions lead to big
            transformations over time.</p>
        <button class="btn btn-primary btn-large" onclick="showAddHabitModal()">
            <i class="fas fa-rocket"></i> Create Your First Habit
        </button>
    </div>
    {% endif %}
</div>

<!-- Add Habit Modal -->
<div id="addHabitModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Add New Habit</h3>
            <span class="close" onclick="closeModal('addHabitModal')">&times;</span>
        </div>
        <form id="addHabitForm" method="POST" action="/add_habit">
            <div class="form-group">
                <label for="habitName" class="form-label">
                    <i class="fas fa-star"></i> Habit Name
                </label>
                <input type="text" id="habitName" name="name" class="form-input" required
                    placeholder="e.g., Drink 8 glasses of water">
            </div>

            <div class="form-group">
                <label for="habitDescription" class="form-label">
                    <i class="fas fa-align-left"></i> Description (Optional)
                </label>
                <textarea id="habitDescription" name="description" class="form-textarea"
                    placeholder="Why is this habit important to you?"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="habitFrequency" class="form-label">
                        <i class="fas fa-calendar-alt"></i> Frequency
                    </label>
                    <select id="habitFrequency" name="frequency" class="form-select">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="habitTarget" class="form-label">
                        <i class="fas fa-bullseye"></i> Target Count
                    </label>
                    <input type="number" id="habitTarget" name="target_count" class="form-input" min="1" value="1"
                        required>
                </div>
            </div>

            <div class="form-group">
                <label for="habitCategory" class="form-label">
                    <i class="fas fa-tag"></i> Category
                </label>
                <input type="text" id="habitCategory" name="category" class="form-input"
                    placeholder="e.g., Health, Learning, Work" value="general">
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closeModal('addHabitModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Habit</button>
            </div>
        </form>
    </div>
</div>

<script>
    function showAddHabitModal() {
        // Reset form for adding new habit
        const form = document.querySelector('#addHabitModal form');
        form.action = '/add_habit';
        form.reset();

        // Reset modal title
        document.querySelector('#addHabitModal h3').textContent = 'Add New Habit';
        document.querySelector('#addHabitModal button[type="submit"]').innerHTML = '<i class="fas fa-plus"></i> Add Habit';

        document.getElementById('addHabitModal').style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function logHabit(habitId) {
        // Simple AJAX call to log habit progress
        fetch(`/log_habit/${habitId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Refresh to show updated progress
                } else {
                    alert('Error logging habit: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error logging habit');
            });
    }

    function editHabit(habitId) {
        // Fetch habit data and show edit modal
        fetch(`/get_habit/${habitId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showEditHabitModal(data.habit);
                } else {
                    alert('Error loading habit data: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading habit data');
            });
    }

    function showEditHabitModal(habit) {
        // Fill the form with existing habit data
        document.getElementById('habitName').value = habit.name;
        document.getElementById('habitDescription').value = habit.description || '';
        document.getElementById('habitFrequency').value = habit.frequency;
        document.getElementById('habitTarget').value = habit.target_count;
        document.getElementById('habitCategory').value = habit.category;

        // Change form action to edit
        const form = document.querySelector('#addHabitModal form');
        form.action = `/edit_habit/${habit.id}`;

        // Change modal title
        document.querySelector('#addHabitModal h3').textContent = 'Edit Habit';
        document.querySelector('#addHabitModal button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Habit';

        document.getElementById('addHabitModal').style.display = 'block';
    }

    function deleteHabit(habitId) {
        if (confirm('Are you sure you want to delete this habit? This action cannot be undone.')) {
            fetch(`/delete_habit/${habitId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting habit: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting habit');
                });
        }
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modals = document.getElementsByClassName('modal');
        for (let modal of modals) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    }
</script>
{% endblock %}